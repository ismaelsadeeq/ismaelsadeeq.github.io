<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Tips and Techniques for Constructing Private Transactions with Privatetx library | Abubakar Sadiq Ismail </title> <meta name="author" content="Abubakar Sadiq Ismail"> <meta name="description" content="How to construct Bitcoin Transactions that are mystery to chain analysis"> <meta name="keywords" content="Abubakar Sadiq Ismail"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/prof_pic.jpeg?4400b4ff2c19f26df087ca783d4c892b"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ismaelsadeeq.github.io/blog/2023/tips-and-techniques-for-constructing-private-txs/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Abubakar</span> Sadiq Ismail </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/books/">bookshelf </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Tips and Techniques for Constructing Private Transactions with Privatetx library</h1> <p class="post-meta"> Created on May 01, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/privacy"> <i class="fa-solid fa-hashtag fa-sm"></i> Privacy</a>   <a href="/blog/tag/bitcoin"> <i class="fa-solid fa-hashtag fa-sm"></i> Bitcoin</a>   <a href="/blog/tag/transaction"> <i class="fa-solid fa-hashtag fa-sm"></i> Transaction</a>   <a href="/blog/tag/chain-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Chain-Analysis</a>   ·   <a href="/blog/category/technical"> <i class="fa-solid fa-tag fa-sm"></i> technical</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h3 id="introduction">Introduction</h3> <p>The Bitcoin blockchain offers users the ability to conduct pseudonymous transactions, but privacy can easily be compromised with common missteps such as reusing addresses, improper coin selection and transaction construction. Worse is taking full custody of users keys and subsequently attaching names or identity documents (KYC) to corresponding keys. As a result, chain analysis tools can easily identify individual users, trace the flow of bitcoins, and de-annonymize transactions. This has significant implications for the privacy and security of Bitcoin users. In this article, we will explore some steps that Bitcoin service builders can take to improve the privacy of their users and minimize the impact of chain analysis tools. By implementing these steps, service providers can offer their users a more secure and private experience on the Bitcoin network, while helping to preserve the core values of Bitcoin as a decentralized and privacy-focused system.</p> <h3 id="keys-custody-and-identity-documents-kyc">Keys Custody and identity documents (KYC)</h3> <p>Service providers should avoid taking full custody of their users private keys and should not associate users’ names or identity documents (KYC) with their Bitcoin addresses. Features such as output descriptors can give users full control over their private keys while reducing service providers’ risks and responsibilities. By importing only the extended public key descriptor, users can recover their Bitcoin balance and transaction history without providing identifying information and provide their private key only when signing a transaction. Although some jurisdictions may require collecting user information, service providers should avoid doing so as much as possible to protect their users’ privacy and the Bitcoin system as a whole.</p> <p>If the above missteps are addressed, then it all comes down to how you construct your transaction. To enhance privacy, avoid reusing addresses when constructing transactions, and perform a coinjoin when aggregating inputs for a payment (combining multiple Bitcoin transactions into a single transaction) to break common input heuristics.</p> <h3 id="privatetx-lib"><a href="http://github.com/ismaelsadeeq/privateTx" rel="external nofollow noopener" target="_blank">Privatetx-lib</a></h3> <p>Privatetx-lib is a library that checks partially signed bitcoin transactions (PSBTs) and provides alerts on whether the given PSBT is vulnerable to common chain analysis heuristics. These heuristics are what chain analysis services use to extract information from transactions, as mentioned in <a href="https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-2-4-20010e0dab97" rel="external nofollow noopener" target="_blank">research by OXT</a> and the <a href="https://en.bitcoin.it/wiki/Privacy" rel="external nofollow noopener" target="_blank">Bitcoin privacy wiki</a>.</p> <p>PSBT’s are used as an input for privatetx-lib because finalized PSBTs contain information about transaction inputs, which enables the algorithm to check for these heuristics. This is unlike a serialized transaction that only provides the input’s transaction ID and output index. Additionally, PSBTs are the current standard used by Bitcoin applications. To learn more about PSBTs and how to use them in your application, refer to <a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki" rel="external nofollow noopener" target="_blank">BIP 174</a>. These Heuristics are:</p> <h4 id="transaction-wide-address-reuse">Transaction Wide Address reuse</h4> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig1.png" alt="Figure 1"> </div> </div> <p><br></p> <p>In the above diagram, the change address of the transaction is the same as the input address. This is bad for privacy because it reveals the owner of the address bc1qzjdnhtrplk32vecxfqz8hmmf3mnenvecmvwhhy as the one who paid 10 bitcoins to the address bc1qaekdm6unw8qr6f5gwg48vfjntqf0xj9zpldwl5 and received 4.8 bitcoins as change. This information can be used to link the owner of the input address with the owner of the output address.</p> <p>The best practice is to use a new address in the change output.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig2.png" alt="Figure 2"> </div> </div> <p><br></p> <p>This approach provides less certainty to an observer in the network about the nature of the outputs. By using a new address for the change output, it becomes less clear whether both outputs are payments or if one of them is a change.</p> <p>Call the private-tx checkAddressReuse function with your PSBT string and ensure that it passes the address reuse heuristic.</p> <h4 id="common-inputs">Common Inputs</h4> <p>If it’s an aggregation transaction, this heuristic will detect that the inputs are consolidated by one wallet for a payment.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig3.png" alt="Figure 1"> </div> </div> <p><br></p> <p>This transaction in the diagram above clearly indicates that the two inputs of 15 and 25 bitcoins were consolidated in order to perform the 35 bitcoin payment. The change output is likely to be the 4.8 bitcoin output.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig4.png" alt="Figure 4"> </div> </div> <p><br></p> <p>A common way to break the address reuse heuristic is to combine it with another transaction, commonly known as coinjoin, which helps to obscure the connection between the inputs and outputs of a transaction and make it difficult to determine whether they belong to the same user.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig5.png" alt="Figure 5"> </div> </div> <p><br></p> <p>In this newly constructed transaction with multiple inputs and payments, it will be difficult for an observer to distinguish between the payment outputs and the change output.</p> <h4 id="check-against-change-detection">Check against change detection</h4> <p>When it’s a distributing transaction, change outputs will be detected. To break the heuristic, you can perform coinjoin, change the script type to match the payment and avoid reusing addresses. It depends on the reason why the change was detected. Private-tx provides information on why change outputs were detected, such as address reuse being a change output, a different output script type indicating a payment, an output value greater than all input values being the payment output, non-round number outputs being change outputs, and the largest output value being the change output.</p> <p>Example of output with a different script type with the input.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig6.png" alt="Figure 6"> </div> </div> <p><br></p> <p>The 1 bitcoin output above is a P2SH, which clearly shows that it is the payment output, and the 0.99999 bitcoin output is the change output.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig7.png" alt="Figure 7"> </div> </div> <p><br></p> <p>To break these heuristics, change the change output address to P2SH.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig8.png" alt="Figure 8"> </div> </div> <p><br></p> <p>An observer of this transaction can not distinguish whether it is the payment or the change output.</p> <h4 id="peeling-transaction">Peeling transaction</h4> <p>It is common that exchanges make settlements in a peeling transaction format below.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig9.png" alt="Figure 9"> </div> </div> <p><br></p> <p>The 19.44444 bitcoin is clearly the change output, whereas 0.5 bitcoin is a payment.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig10.png" alt="Figure 10"> </div> </div> <p><br></p> <p>To break the peeling transaction heuristic, it is recommended for exchange builders to avoid peeling the transaction and improve the privacy of their transactions. Peeling transactions often occur due to the reuse of addresses and the accumulation of large amounts of bitcoin in a single address, resulting in a large value input that needs to be peeled off to settle a customer. Instead, it is suggested to avoid reusing addresses and have a low value output that can be used to settle a customer. By doing this, exchange builders can ensure the privacy of their transactions and avoid the detection of the peeling heuristic.</p> <p>You can use Private-tx to check whether a transaction is a peeling transaction or not.</p> <p>Check https://github.com/ismaelsadeeq/privateTx to learn how to install and use privatetx-lib, it is a JavaScript library and services that are based on TypeScript or JavaScript can leverage on privatetx-lib to improve how they construct their transaction and ensure they are resilient to chain analysis tools.</p> <p>Chain analysis tools use heuristics to analyze the Bitcoin blockchain transaction by transaction. These heuristics cluster wallets, predict their unspent balance, and track their payment history. The tools determine the change and payment outputs in a transaction and link the spending transaction of the change output to previous transactions. By checking for the reuse of the input or change output address, the tools create a graph of clusters of wallets and their payments over time, along with the remaining balance currently held.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig11.png" alt="Figure 11"> </div> </div> <p><em>Image By Gaurav Agrawal Coinpath August 15, 2020</em></p> <p><br></p> <p>However, this data alone is not enough to identify the real-world identities behind these wallets. That’s where collaboration with exchanges and wallets that require personal identifiable information comes into play. With this collaboration, chain analysis tools can link real identities with payments or wallets, potentially compromising the privacy of users.</p> <p><br></p> <div class="row mt-3"> <div class="col-sm-8"> <img class="img-fluid rounded z-depth-1" src="/assets/img/privatetx/fig12.png" alt="Figure 12"> </div> </div> <p><br></p> <p>The above example in the diagram illustrates how the identity of a Bitcoin user was revealed due to privacy missteps by their wallet. This demonstrates how a compromise of privacy not only affects the victim, but also the people with whom they transact.</p> <h3 id="conclusion">Conclusion</h3> <p>Protecting user privacy is essential in preserving the core values of Bitcoin as a decentralized and privacy-focused system. Bitcoin service builders should take several steps to minimize the impact of chain analysis tools on their users by using of tools like privatetx-lib, which can help service providers improve how they construct their transactions. By implementing these steps, Bitcoin service providers can offer their users a more secure and private experience on the Bitcoin network, while protecting their privacy and maintaining their reputation as a privacy-focused service.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2026 Abubakar Sadiq Ismail. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> </body> </html>